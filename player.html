<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #8a2be2; }
        * { 
            box-sizing: border-box; margin: 0; padding: 0; 
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        body, html { 
            width: 100%; height: 100%; background-color: #000; 
            overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        }
        
        .player-container { position: relative; width: 100%; height: 100%; background-color: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }

        .controls-overlay {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 25%, transparent 70%, rgba(0,0,0,0.7) 100%);
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .controls-overlay.visible { opacity: 1; visibility: visible; }

        .top-bar { padding: 20px 40px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .top-left { display: flex; align-items: center; gap: 20px; }
        .top-bar a { color: #fff; font-size: 24px; text-decoration: none; }
        .top-bar h3 { margin: 0; font-size: 16px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); color: #fff; }

        /* Indicador de Salvamento */
        .save-indicator {
            position: fixed; top: 20px; right: 20px;
            background: rgba(0, 255, 0, 0.8); color: #000;
            padding: 8px 15px; border-radius: 5px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; gap: 8px;
            opacity: 0; transition: opacity 0.3s ease; z-index: 9999;
            pointer-events: none;
        }
        .save-indicator.show { opacity: 1; }

        .bottom-bar { padding: 15px 40px; }
        .progress-bar-container { width: 100%; height: 5px; background: rgba(255,255,255,0.3); cursor: pointer; margin-bottom: 10px; border-radius: 5px; }
        .progress-bar { width: 0; height: 100%; background: var(--accent); border-radius: 5px; }
        
        .bottom-controls { display: flex; justify-content: space-between; align-items: center; }
        .controls-left, .controls-right { display: flex; align-items: center; gap: 25px; }
        .bottom-controls button { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 5px; display: flex; align-items: center; gap: 8px; }
        .bottom-controls button .btn-text { font-size: 16px; display: none; }
        .player-container:fullscreen .bottom-controls .btn-text { display: flex !important; }
        .time-display { font-size: 14px; font-weight: 500; color: #fff; }
        
        #skip-intro-btn {
            position: absolute; bottom: 100px; left: 40px; z-index: 20;
            background: rgba(30,30,30,0.8); color: #fff; border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #skip-intro-btn.visible { opacity: 1; visibility: visible; }

        .episodes-sidebar {
            position: fixed; top: 0; right: 0; bottom: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px); transform: translateX(100%);
            transition: transform 0.3s ease-out; z-index: 30;
            display: flex; flex-direction: column; padding-top: 60px;
        }
        .episodes-sidebar.visible { transform: translateX(0); }
        .sidebar-header { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .sidebar-header h4 { margin: 0; font-size: 24px; color: #fff; }
        .sidebar-header .close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
        .sidebar-content { flex: 1; overflow-y: auto; overflow-x: hidden; }
        .season-selector { padding: 15px 40px; background: transparent; border-bottom: none; text-align: right; margin-top: 20px; }
        .season-selector select { 
            width: auto; padding: 8px 15px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 16px; appearance: none; 
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%01-13%205.7H18.4c-5%200-9.3-1.8-12.9-5.7-3.6-3.9-5.4-8.7-5.4-13.9%200-5.2%201.8-10%205.4-13.9L132.3%203.5c3.6-3.9%208.4-5.7%2013.9-5.7s10.3%201.8%2013.9%205.7l114.8%20114.8c3.6%203.9%205.4%208.7%205.4%2013.9%200%205.2-1.8%2010-5.4%2013.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 10px center; background-size: 12px; padding-right: 30px; cursor: pointer;
        }
        .ep-list { list-style: none; padding: 20px 40px; margin: 0; display: flex; overflow-x: auto; gap: 20px; scrollbar-width: none; }
        .ep-list::-webkit-scrollbar { display: none; }
        .ep-list-item {
            min-width: 250px; background: #1a1a1a; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; flex-shrink: 0; display: flex; flex-direction: column; position: relative;
        }
        .ep-list-item:hover { border-color: var(--accent); }
        .ep-list-item.active { border-color: var(--accent); }
        .ep-list-item .thumb { width: 100%; height: 140px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; position: relative; }
        .ep-list-item .info { padding: 15px; }
        .ep-list-item .info h5 { margin: 0 0 5px; font-size: 14px; color: #fff; }
        .ep-list-item .info p { margin: 0; font-size: 12px; color: #aaa; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

        @media screen and (orientation: landscape) and (min-width: 768px) {
            .episodes-sidebar { width: 400px; left: auto; }
            .ep-list { flex-wrap: wrap; justify-content: flex-start; }
            .ep-list-item { min-width: 200px; max-width: 200px; }
        }

        @media screen and (max-width: 767px) {
            .top-bar, .bottom-bar, .season-selector, .ep-list { padding-left: 20px; padding-right: 20px; }
            .ep-list-item { min-width: 180px; max-width: 180px; }
            .ep-list .ep-list-item .thumb { height: 100px; }
            .ep-list .ep-list-item .info h5 { font-size: 13px; }
            .ep-list .ep-list-item .info p { font-size: 11px; -webkit-line-clamp: 2; }
        }
    </style>
</head>
<body>
    <div class="player-container" id="player-container">
        <video id="video-player" playsinline></video>
        
        <div id="save-indicator" class="save-indicator">
            <i class="fa-solid fa-cloud-arrow-up"></i>
            <span>Progresso salvo!</span>
        </div>

        <div class="controls-overlay" id="controls-overlay">
            <div class="top-bar">
                <div class="top-left">
                    <a href="javascript:history.back()"><i class="fa-solid fa-arrow-left"></i></a>
                    <h3 id="title"></h3>
                </div>
            </div>
            <div class="bottom-bar">
                <div class="progress-bar-container" id="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="bottom-controls">
                    <div class="controls-left">
                        <button id="play-pause-btn"><i class="fa-solid fa-play"></i></button>
                        <span class="time-display" id="time-display">00:00 / 00:00</span>
                    </div>
                    <div class="controls-right">
                        <button id="episodes-btn" style="display: none;"><i class="fa-solid fa-bars"></i><span class="btn-text"> Episódios</span></button>
                        <button id="next-ep-btn" style="display: none;"><i class="fa-solid fa-forward-step"></i><span class="btn-text"> Próximo EP</span></button>
                        <button id="fullscreen-btn"><i class="fa-solid fa-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <button id="skip-intro-btn">Pular Intro</button>

        <div class="episodes-sidebar" id="episodes-sidebar">
            <div class="sidebar-header">
                <h4>Episódios</h4>
                <button class="close-btn" id="close-sidebar-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="sidebar-content">
                <div class="season-selector">
                    <select id="season-select"></select>
                </div>
                <ul class="ep-list" id="ep-list"></ul>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Config (Exatamente como no seu Termux)
        const supabaseUrl = 'https://arkeruofrcqqluejrglu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFya2VydW9mcmNxcWx1ZWpyZ2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk3OTU5MDAsImV4cCI6MjA1NTM3MTkwMH0.9G_u_mXvX7Y_fX_X_X_X_X_X_X_X_X_X_X_X_X_X_X_X'; 
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Elementos
        const playerContainer = document.getElementById('player-container');
        const video = document.getElementById('video-player');
        const controlsOverlay = document.getElementById('controls-overlay');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const timeDisplay = document.getElementById('time-display');
        const titleElem = document.getElementById('title');
        const episodesBtn = document.getElementById('episodes-btn');
        const nextEpBtn = document.getElementById('next-ep-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const skipIntroBtn = document.getElementById('skip-intro-btn');
        const episodesSidebar = document.getElementById('episodes-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const seasonSelect = document.getElementById('season-select');
        const epList = document.getElementById('ep-list');
        const saveIndicator = document.getElementById('save-indicator');

        // Dados do Conteúdo
        const urlParams = new URLSearchParams(window.location.search);
        const contentId = urlParams.get('id');
        let currentSeasonNum = urlParams.get('season');
        let currentEpNum = urlParams.get('ep');
        
        // ID de Usuário (Como você quer sem login, usaremos um ID fixo ou baseado no navegador)
        const userId = "visitante_anonimo"; 

        let currentItem;
        let episodesBySeason;
        let saveInterval;
        let controlsTimeout;

        // Funções do Player
        function togglePlay() {
            const icon = playPauseBtn.querySelector('i');
            if (video.paused) { video.play(); icon.className = 'fa-solid fa-pause'; } 
            else { video.pause(); icon.className = 'fa-solid fa-play'; }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return video.duration >= 3600 ? `${h}:${m}:${s}` : `${m}:${s}`;
        }

        function handleTimeUpdate() {
            const progress = (video.currentTime / video.duration) * 100;
            progressBar.style.width = `${progress}%`;
            timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
            if (currentItem && currentItem.tipo === 'serie') {
                if (video.currentTime > 30 && video.currentTime < 120) skipIntroBtn.classList.add('visible');
                else skipIntroBtn.classList.remove('visible');
            }
        }

        function handleProgressBarClick(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            video.currentTime = (clickX / rect.width) * video.duration;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) playerContainer.requestFullscreen().catch(err => console.error(`Erro: ${err.message}`));
            else document.exitFullscreen();
        }

        function handleSkipIntro() {
            video.currentTime += 85;
            skipIntroBtn.classList.remove('visible');
        }

        function showControls() {
            controlsOverlay.classList.add('visible');
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => {
                controlsOverlay.classList.remove('visible');
            }, 3000);
        }
        
        function handleScreenClick(e) {
            if (e.target === video || e.target === controlsOverlay || e.target.closest('.top-bar') || e.target.closest('.bottom-bar')) showControls();
        }

        function showSaveIndicator() {
            saveIndicator.classList.add('show');
            setTimeout(() => saveIndicator.classList.remove('show'), 2000);
        }

        // SALVAMENTO DIRETO (Igual ao Termux)
        async function saveProgress() {
            if (isNaN(video.duration) || video.currentTime === 0) return;
            
            const progressData = {
                uid: userId, // ID fixo para salvar sem login
                contentId: contentId,
                season: currentSeasonNum ? parseInt(currentSeasonNum) : null,
                episode: currentEpNum ? parseInt(currentEpNum) : null,
                time: video.currentTime,
                duration: video.duration,
                date: Date.now(),
                title: currentItem ? currentItem.titulo : 'Filme'
            };

            try {
                const { error } = await supabaseClient
                    .from('watch_progress')
                    .upsert(progressData, { onConflict: 'uid,contentId,season,episode' });
                
                if (!error) showSaveIndicator();
                else console.error("Erro Supabase:", error);
            } catch (err) {
                console.error("Erro Crítico:", err);
            }
        }

        // CARREGAMENTO DIRETO
        async function getSavedProgress() {
            try {
                let query = supabaseClient
                    .from('watch_progress')
                    .select('time')
                    .eq('uid', userId)
                    .eq('contentId', contentId);
                
                if (currentSeasonNum) query = query.eq('season', parseInt(currentSeasonNum));
                if (currentEpNum) query = query.eq('episode', parseInt(currentEpNum));

                const { data, error } = await query.single();
                return (data && !error) ? data : null;
            } catch (error) {
                return null;
            }
        }

	        async function loadEpisode(seasonNumber, episodeNumber) {
            await saveProgress();
            currentSeasonNum = seasonNumber;
            currentEpNum = episodeNumber;
            
            const currentEpisode = episodesBySeason[currentSeasonNum].find(ep => ep.episodio == currentEpNum);
            if (!currentEpisode) return;

            video.src = currentEpisode.link_mp4;
            titleElem.textContent = `${currentItem.titulo} - T${currentSeasonNum}:E${currentEpNum} "${currentEpisode.nome}"`;
            
            const savedData = await getSavedProgress();
            video.currentTime = savedData ? savedData.time : 0;
            
            video.play();
            updateSidebarActive();
        }

        function loadNextEpisode() {
            const currentSeasonEpisodes = episodesBySeason[currentSeasonNum];
            const currentEpIndex = currentSeasonEpisodes.findIndex(ep => ep.episodio == currentEpNum);
            
            if (currentEpIndex < currentSeasonEpisodes.length - 1) {
                const nextEp = currentSeasonEpisodes[currentEpIndex + 1];
                loadEpisode(nextEp.temporada, nextEp.episodio);
            } else {
                window.location.href = `detalhes.html?id=${contentId}`;
            }
        }

        function updateSidebarActive() {
            document.querySelectorAll('.ep-list-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.ep-list-item[data-season="${currentSeasonNum}"][data-ep="${currentEpNum}"]`);
            if (activeItem) activeItem.classList.add('active');
        }

        function renderSeasonEpisodes(seasonNum) {
            epList.innerHTML = '';
            episodesBySeason[seasonNum].forEach(ep => {
                const li = document.createElement('li');
                li.className = 'ep-list-item';
                li.dataset.season = ep.temporada;
                li.dataset.ep = ep.episodio;
                li.innerHTML = `
                    <div class="thumb" style="background-image: url(${ep.capa})">
                        <div class="play-icon-overlay"><i class="fa-solid fa-play"></i></div>
                    </div>
                    <div class="info">
                        <h5>${ep.episodio}. ${ep.nome}</h5>
                        <p>${ep.sinopse}</p>
                    </div>`;
                li.addEventListener('click', () => loadEpisode(ep.temporada, ep.episodio));
                epList.appendChild(li);
            });
            updateSidebarActive();
        }

        async function initializePlayer() {
            if (!contentId) return;
            
            try { await screen.orientation.lock('landscape'); } 
            catch (err) { }

            try {
                const response = await fetch(`https://pkapi-six.vercel.app/page/detalhes_ID?id=${contentId}`);
                currentItem = await response.json();
                document.title = currentItem.titulo;

                if (currentItem.tipo === 'serie') {
                    episodesBySeason = currentItem.episodios.reduce((acc, ep) => {
                        (acc[ep.temporada] = acc[ep.temporada] || []).push(ep);
                        return acc;
                    }, {});

                    Object.keys(episodesBySeason).forEach(seasonNum => {
                        seasonSelect.innerHTML += `<option value="${seasonNum}">Temporada ${seasonNum}</option>`;
                    });
                    
                    seasonSelect.value = currentSeasonNum;
                    renderSeasonEpisodes(currentSeasonNum);
                    episodesBtn.style.display = 'block';
                    nextEpBtn.style.display = 'block';
                    await loadEpisode(currentSeasonNum, currentEpNum);
                } else {
                    video.src = currentItem.link_mp4;
                    titleElem.textContent = currentItem.titulo;
                    const savedData = await getSavedProgress();
                    if (savedData) video.currentTime = savedData.time;
                    video.play();
                }

                // Eventos
                video.addEventListener('timeupdate', handleTimeUpdate);
                video.addEventListener('play', () => playPauseBtn.querySelector('i').className = 'fa-solid fa-pause');
                video.addEventListener('pause', () => playPauseBtn.querySelector('i').className = 'fa-solid fa-play');
                progressBarContainer.addEventListener('click', handleProgressBarClick);
                playPauseBtn.addEventListener('click', togglePlay);
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                skipIntroBtn.addEventListener('click', handleSkipIntro);
                video.addEventListener('click', handleScreenClick);
                controlsOverlay.addEventListener('click', handleScreenClick);
                playerContainer.addEventListener('mousemove', showControls);
                nextEpBtn.addEventListener('click', loadNextEpisode);
                episodesBtn.addEventListener('click', () => episodesSidebar.classList.add('visible'));
                closeSidebarBtn.addEventListener('click', () => episodesSidebar.classList.remove('visible'));
                seasonSelect.addEventListener('change', () => renderSeasonEpisodes(seasonSelect.value));

                // Intervalo de Salvamento (5s)
                saveInterval = setInterval(saveProgress, 5000);
            } catch (error) {
                document.body.innerHTML = `<h1 style="color: white; text-align: center; padding-top: 50px;">Erro: ${error.message}</h1>`;
            }
        }

        // Iniciar
        initializePlayer();
        window.addEventListener('beforeunload', saveProgress);
    </script>
</body>
</html>
