<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buscar - PKFilmes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #0b0b0b;
            --surface: #1a1a1a;
            --accent: #8a2be2;
            --accent-light: #a855f7;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --nav-bg: rgba(11, 11, 11, 0.8);
            --card-radius: 8px;
            --transition: all 0.3s ease;
            --gray-light: #333;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* Header Estilo Netflix Mobile */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: var(--bg);
            padding: 10px 15px;
            border-bottom: 1px solid #222;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .search-bar {
            flex: 1;
            background: var(--gray-light);
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 12px 12px;
            gap: 10px;
        }

        .search-bar i {
            color: #888;
            font-size: 16px;
        }

        .search-input {
            flex: 1;
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .search-input::placeholder {
            color: #888;
        }

        .mic-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
        }

        .mic-btn.active {
            color: var(--accent);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Conteúdo Principal */
        main {
            margin-top: 80px;
            min-height: 100vh;
        }

        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .clear-all-btn {
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* Pesquisas Recentes */
        .recent-searches {
            padding: 0 15px 15px 15px;
            display: none;
        }

        .recent-searches.active {
            display: block;
        }

        .recent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .recent-text {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #bbb;
            font-size: 14px;
            flex: 1;
            cursor: pointer;
        }

        .recent-text i {
            font-size: 12px;
        }

        .remove-recent {
            color: #555;
            padding: 5px;
            cursor: pointer;
        }

        /* SEÇÃO CONTINUAR ASSISTINDO */
        .continue-watching-section {
            margin: 15px 0;
            position: relative;
            display: none;
        }

        .continue-watching-section.active {
            display: block;
        }

        .continue-scroll-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 0 15px 10px 15px;
            scrollbar-width: none;
        }

        .continue-scroll-container::-webkit-scrollbar {
            display: none;
        }

        .continue-card {
            min-width: 140px;
            max-width: 140px;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }

        .continue-card:hover {
            transform: scale(1.02);
            border-color: var(--accent);
        }

        .continue-thumb {
            width: 100%;
            height: 79px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .continue-thumb::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 40%);
        }

        .continue-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            font-size: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .continue-remove:hover {
            background: #ff4b4b;
            border-color: #ff4b4b;
        }

        .continue-info {
            padding: 8px;
        }

        .continue-name {
            font-size: 12px;
            font-weight: 700;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .continue-meta {
            font-size: 10px;
            color: #888;
            font-weight: 600;
            margin-top: 2px;
        }

        .continue-progress-container {
            width: 100%;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }

        .continue-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
        }

        /* Lista de Recomendações e Resultados */
        .list-container {
            display: flex;
            flex-direction: column;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .list-item:active {
            background: #1a1a1a;
        }

        .item-poster {
            width: 120px;
            height: 70px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .item-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .item-poster iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .item-poster iframe.active {
            display: block;
        }

        .item-title {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            background: none;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #111 25%, #1a1a1a 50%, #111 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Navegação Inferior (Padronizada com Início) */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--nav-bg);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-dim);
            text-decoration: none;
            font-size: 10px;
            font-weight: 600;
            transition: var(--transition);
            flex: 1;
        }

        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--accent); }
        .nav-profile { width: 24px; height: 24px; border-radius: 50%; background: #333; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .nav-profile img { width: 100%; height: 100%; object-fit: cover; }

        /* Camada de Erro/Loading */
        #status-message {
            text-align: center;
            padding: 50px 20px;
            color: #888;
            display: none;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <button class="back-btn" onclick="window.history.back()"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" class="search-input" id="search-input" placeholder="Busque séries, filmes, videos...">
                <button class="mic-btn" id="mic-btn" onclick="startVoiceSearch()"><i class="fa-solid fa-microphone"></i></button>
            </div>
        </div>
    </header>

    <main id="main-content">
        <!-- Seção de Pesquisas Recentes -->
        <div id="recent-container" class="recent-searches">
            <div class="section-header-row">
                <h2 class="section-title">Pesquisas recentes</h2>
                <button class="clear-all-btn" onclick="clearAllRecent()">Limpar tudo</button>
            </div>
            <div id="recent-list">
                <!-- Itens de pesquisas recentes -->
            </div>
        </div>

        <!-- SEÇÃO CONTINUAR ASSISTINDO -->
        <div id="continue-watching-wrapper" class="continue-watching-section">
            <h2 class="section-title" style="padding: 15px;">Continuar Assistindo</h2>
            <div class="continue-scroll-container" id="continue-list">
                <!-- Itens do continuar assistindo -->
            </div>
        </div>

        <h2 id="section-title" class="section-title" style="padding: 15px;">Séries e filmes recomendados</h2>
        <div id="list-container" class="list-container">
            <!-- Os itens serão carregados aqui -->
            <div class="list-item"><div class="item-poster skeleton"></div><div class="item-title skeleton" style="height:14px; width:60%;"></div></div>
            <div class="list-item"><div class="item-poster skeleton"></div><div class="item-title skeleton" style="height:14px; width:40%;"></div></div>
            <div class="list-item"><div class="item-poster skeleton"></div><div class="item-title skeleton" style="height:14px; width:70%;"></div></div>
        </div>
        <div id="status-message"></div>
    </main>

    <nav class="nav">
        <a href="início.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Início</span></a>
        <a href="buscar.html" class="nav-item active"><i class="fa-solid fa-magnifying-glass"></i><span>Buscar</span></a>
        <a href="novidades.html" class="nav-item"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Novidades</span></a>
        <a href="perfil.html" class="nav-item"><div class="nav-profile" id="user-profile-icon"><i class="fa-solid fa-user"></i></div><span>Perfil</span></a>
    </nav>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIQSqbbN-adfJjONc0pmTY4PZahwk6a6w",
            authDomain: "nupcine.firebaseapp.com",
            databaseURL: "https://nupcine-default-rtdb.firebaseio.com",
            projectId: "nupcine",
            storageBucket: "nupcine.appspot.com",
            messagingSenderId: "602295443044",
            appId: "1:602295443044:web:af618627a1dbe5b142c971",
            measurementId: "G-YD3TPSJTCF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, async (user) => {
            const navProfileIcon = document.getElementById('user-profile-icon');
            if (user) {
                const snapshot = await get(child(ref(db), `users/${user.uid}/profile`));
                const profileData = snapshot.exists() ? snapshot.val() : {};
                const photoUrl = profileData.profilePhoto || user.photoURL;
                if (photoUrl) {
                    navProfileIcon.innerHTML = `<img src="${photoUrl}" class="nav-profile-img" alt="Perfil">`;
                }
            }
        });
    </script>

    <script>
        const API_URL = "https://pkfilmes.pages.dev/movies_data.json";
        let allContent = [];
        let searchTimeout = null;

        // Gerenciamento de Pesquisas Recentes
        const RECENT_KEY = 'pkfilmes_recent_searches';
        
        function getRecentSearches() {
            const stored = localStorage.getItem(RECENT_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveRecentSearch(query) {
            if (!query || query.trim() === '') return;
            let recent = getRecentSearches();
            // Remove se já existir para colocar no topo
            recent = recent.filter(s => s.toLowerCase() !== query.toLowerCase());
            // Adiciona no topo
            recent.unshift(query);
            // Mantém apenas as 5 últimas
            recent = recent.slice(0, 5);
            localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
            renderRecentSearches();
        }
	        function removeRecentSearch(query) {
            let recent = getRecentSearches();
            recent = recent.filter(s => s !== query);
            localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
            renderRecentSearches();
        }

        function clearAllRecent() {
            localStorage.removeItem(RECENT_KEY);
            renderRecentSearches();
        }

        function renderRecentSearches() {
            const recent = getRecentSearches();
            const container = document.getElementById('recent-container');
            const list = document.getElementById('recent-list');
            const searchInput = document.getElementById('search-input');
            
            if (recent.length > 0 && searchInput.value.trim() === '') {
                container.classList.add('active');
                list.innerHTML = '';
                recent.forEach(term => {
                    const item = document.createElement('div');
                    item.className = 'recent-item';
                    item.innerHTML = `
                        <div class="recent-text" onclick="fillSearch('${term.replace(/'/g, "\\'")}')">
                            <i class="fa-solid fa-history"></i>
                            <span>${term}</span>
                        </div>
                        <div class="remove-recent" onclick="removeRecentSearch('${term.replace(/'/g, "\\'")}')">
                            <i class="fa-solid fa-xmark"></i>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                container.classList.remove('active');
            }
        }

        function fillSearch(term) {
            const input = document.getElementById('search-input');
            input.value = term;
            performSearch(term);
        }

        /* --- BUSCA POR VOZ --- */
        function startVoiceSearch() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Seu navegador não suporta busca por voz.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            const micBtn = document.getElementById('mic-btn');

            recognition.onstart = () => {
                micBtn.classList.add('active');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('search-input').value = transcript;
                performSearch(transcript);
            };

            recognition.onerror = () => {
                micBtn.classList.remove('active');
            };

            recognition.onend = () => {
                micBtn.classList.remove('active');
            };

            recognition.start();
        }

        /* --- SISTEMA CONTINUAR ASSISTINDO --- */
        function renderContinueWatching() {
            const wrapper = document.getElementById('continue-watching-wrapper');
            const listContainer = document.getElementById('continue-list');
            
            if (!wrapper || !listContainer) return;
            
            listContainer.innerHTML = '';

            const localProgress = JSON.parse(localStorage.getItem('user_progress') || '[]');
            
            if (localProgress.length > 0) {
                wrapper.classList.add('active');
                localProgress.forEach(data => {
                    const details = allContent.find(i => i.id == data.id);
                    if (details) {
                        const card = createContinueCard(data, details);
                        listContainer.appendChild(card);
                    }
                });
            } else {
                wrapper.classList.remove('active');
            }
        }

        function createContinueCard(data, details) {
            const card = document.createElement('div');
            card.className = 'continue-card';
            
            let thumb = details.banner || details.capa;
            let title = details.titulo;
            let meta = details.generos ? details.generos.split(',')[0] : '';
            let link = `detalhes.html?id=${data.id}`;

            if (data.season && data.episode) {
                meta = `T${data.season} EP${data.episode}`;
                link = `player.html?id=${data.id}&season=${data.season}&ep=${data.episode}`;
            }

            const progress = data.progress || 0;

            card.innerHTML = `
                <div class="continue-remove" onclick="event.stopPropagation(); removeFromContinue('${data.id}')">
                    <i class="fa-solid fa-xmark"></i>
                </div>
                <div class="continue-thumb" style="background-image: url('${thumb}')" onclick="window.location.href='${link}'"></div>
                <div class="continue-info" onclick="window.location.href='${link}'">
                    <div class="continue-name">${title}</div>
                    <div class="continue-meta">${meta}</div>
                    <div class="continue-progress-container">
                        <div class="continue-progress-bar" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
            return card;
        }

        window.removeFromContinue = (id) => {
            let localProgress = JSON.parse(localStorage.getItem('user_progress') || '[]');
            localProgress = localProgress.filter(i => i.id != id);
            localStorage.setItem('user_progress', JSON.stringify(localProgress));
            renderContinueWatching();
        };

        /* --- BUSCA INTELIGENTE COM FUZZY --- */
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "");
        }

        function fuzzyMatch(text, query) {
            const t = normalizeText(text);
            const q = normalizeText(query);
            
            if (t.includes(q)) return true;
            
            const queryWords = q.split(' ');
            return queryWords.every(word => {
                if (word.length < 3) return t.includes(word);
                const textWords = t.split(' ');
                return textWords.some(tWord => {
                    if (Math.abs(tWord.length - word.length) > 1) return false;
                    let diffs = 0;
                    let i = 0, j = 0;
                    while (i < word.length && j < tWord.length) {
                        if (word[i] !== tWord[j]) diffs++;
                        i++; j++;
                    }
                    return diffs <= 1;
                });
            });
        }

        function goToDetailPage(id) {
            window.location.href = `detalhes.html?id=${id}`;
        }

        function shuffleArray(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function renderList(items) {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            if (items.length === 0) {
                document.getElementById('status-message').style.display = 'block';
                document.getElementById('status-message').innerHTML = '<i class="fa-solid fa-circle-exclamation"></i><p>Nenhum resultado encontrado.</p>';
                return;
            }

            document.getElementById('status-message').style.display = 'none';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => {
                    saveRecentSearch(document.getElementById('search-input').value);
                    goToDetailPage(item.id);
                };
                
                const trailerHTML = item.trailer_id ? `<iframe src="https://www.youtube.com/embed/${item.trailer_id}?autoplay=1&mute=1&controls=0&loop=1&playlist=${item.trailer_id}" allow="autoplay"></iframe>` : '';
                
                div.innerHTML = `
                    <div class="item-poster">
                        <img src="${item.banner || item.capa}" alt="${item.titulo}" onerror="this.src='https://via.placeholder.com/120x70?text=Sem+Imagem'">
                        ${trailerHTML}
                    </div>
                    <div class="item-title">${item.titulo}</div>
                    <div class="play-btn">
                        <i class="fa-solid fa-play"></i>
                    </div>
                `;
                
                if (item.trailer_id) {
                    const poster = div.querySelector('.item-poster');
                    const img = poster.querySelector('img');
                    const iframe = poster.querySelector('iframe');
                    let pressTimer = null;
                    
                    const startPreview = () => {
                        pressTimer = setTimeout(() => {
                            img.style.display = 'none';
                            iframe.classList.add('active');
                        }, 300);
                    };
                    
                    const stopPreview = () => {
                        clearTimeout(pressTimer);
                        img.style.display = 'block';
                        iframe.classList.remove('active');
                    };
                    
                    poster.addEventListener('mousedown', startPreview);
                    poster.addEventListener('mouseup', stopPreview);
                    poster.addEventListener('mouseleave', stopPreview);
                    poster.addEventListener('touchstart', startPreview);
                    poster.addEventListener('touchend', stopPreview);
                }
                
                container.appendChild(div);
            });
        }

        function performSearch(query) {
            const titleElement = document.getElementById('section-title');
            const q = query.trim();
            
            if (q === '') {
                titleElement.textContent = "Séries e filmes recomendados";
                renderList(shuffleArray([...allContent]).slice(0, 20));
                renderRecentSearches();
                renderContinueWatching();
            } else {
                titleElement.textContent = "Principais resultados";
                document.getElementById('recent-container').classList.remove('active');
                document.getElementById('continue-watching-wrapper').classList.remove('active');
                
                const filtered = allContent.filter(item => 
                    fuzzyMatch(item.titulo, q) || 
                    (item.generos && fuzzyMatch(item.generos, q))
                );
                renderList(filtered);
            }
        }

        async function init() {
            try {
                const response = await fetch(API_URL);
                allContent = await response.json();
                
                if (!Array.isArray(allContent)) throw new Error("Erro ao carregar dados");

                const recommendations = shuffleArray([...allContent]).slice(0, 20);
                renderList(recommendations);
                renderRecentSearches();
                renderContinueWatching();

                document.getElementById('search-input').addEventListener('input', (e) => {
                    const query = e.target.value;
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch(query);
                    }, 500);
                });

            } catch (error) {
                console.error(error);
                document.getElementById('list-container').innerHTML = '';
                document.getElementById('status-message').style.display = 'block';
                document.getElementById('status-message').innerHTML = `<p>Erro ao carregar conteúdo: ${error.message}</p>`;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
