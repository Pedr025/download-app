<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Onboarding - PKFilmes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #0b0b0b;
            --surface: #1a1a1a;
            --accent: #8a2be2;
            --accent-light: #a855f7;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --transition: all 0.3s ease;
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
        }

        #onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .onboarding-step {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease;
            padding-bottom: 150px;
        }

        .onboarding-step.active { display: flex; }

        .onboarding-title { 
            font-size: 28px; 
            font-weight: 800; 
            margin-bottom: 10px; 
            text-align: center;
            margin-top: 20px;
        }

        .onboarding-subtitle { 
            font-size: 15px; 
            color: var(--text-dim); 
            margin-bottom: 30px; 
            text-align: center;
            max-width: 600px;
        }

        .search-container { 
            width: 100%; 
            position: relative; 
            margin-bottom: 25px; 
        }

        .search-input {
            width: 100%;
            padding: 15px 45px 15px 20px;
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 30px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: var(--transition);
        }

        .search-input:focus {
            border-color: var(--accent);
            background: rgba(26, 26, 26, 0.8);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            pointer-events: none;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            width: 100%;
            margin-bottom: 30px;
        }

        .selectable-card {
            aspect-ratio: 2/3;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
            background: var(--surface);
        }

        .selectable-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            loading: lazy;
        }

        .selectable-card.selected { 
            border-color: var(--accent); 
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
        }

        .selectable-card.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 10;
        }

        .category-selection { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            justify-content: center;
            margin-bottom: 30px;
        }

        .selectable-tag {
            padding: 12px 25px;
            background: var(--surface);
            border-radius: 30px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            font-weight: 600;
            font-size: 14px;
        }

        .selectable-tag:hover {
            border-color: var(--accent);
        }

        .selectable-tag.selected { 
            background: var(--accent); 
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        }

        .saga-selection { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            width: 100%;
            margin-bottom: 30px;
        }

        .saga-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .saga-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.2;
            z-index: 1;
        }

        .saga-card span { 
            position: relative; 
            z-index: 2; 
            font-weight: 800; 
            font-size: 16px;
        }

        .saga-card.selected { 
            border-color: var(--accent); 
            background: rgba(138, 43, 226, 0.15);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
        }

        .onboarding-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, #000 70%, transparent);
            display: flex;
            justify-content: center;
            z-index: 10000;
        }

        .btn-continue {
            padding: 15px 60px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-continue.active {
            opacity: 1;
            pointer-events: auto;
            box-shadow: 0 0 20px var(--accent);
        }

        .btn-continue:active {
            transform: scale(0.98);
        }

        .progress-indicator {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: var(--transition);
        }

        .progress-dot.active {
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }

        .loading-text {
            text-align: center;
            color: var(--text-dim);
            font-size: 14px;
            margin: 20px 0;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @media (max-width: 768px) {
            .saga-selection {
                grid-template-columns: 1fr;
            }
            .selection-grid {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            }
        }
    </style>
</head>
<body>

    <div id="onboarding-overlay">
        <!-- PASSO 1: FILMES PREFERIDOS -->
        <div class="onboarding-step active" id="step-movies">
            <div class="progress-indicator">
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            <h1 class="onboarding-title">Escolha seus favoritos</h1>
            <p class="onboarding-subtitle">Selecione no mínimo 6 filmes ou séries que você ama. Use a busca para encontrar rapidamente.</p>
            
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Pesquisar filmes..." id="onboarding-search">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
            </div>

            <div id="loading-indicator" class="loading-text" style="display:none;">Carregando filmes...</div>
            <div class="selection-grid" id="onboarding-movies-grid"></div>
        </div>

        <!-- PASSO 2: CATEGORIAS PREFERIDAS -->
        <div class="onboarding-step" id="step-categories">
            <div class="progress-indicator">
                <div class="progress-dot"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
            </div>
            <h1 class="onboarding-title">O que você gosta de assistir?</h1>
            <p class="onboarding-subtitle">Escolha no mínimo 3 categorias preferidas para personalizarmos suas recomendações.</p>
            
            <div class="category-selection" id="onboarding-categories-grid"></div>
        </div>

        <!-- PASSO 3: SAGAS -->
        <div class="onboarding-step" id="step-sagas">
            <div class="progress-indicator">
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot active"></div>
            </div>
            <h1 class="onboarding-title">Escolha suas Sagas Favoritas</h1>
            <p class="onboarding-subtitle">Selecione as franquias que você mais gosta. Elas aparecerão destacadas na sua home.</p>
            
            <div class="saga-selection" id="onboarding-sagas-grid"></div>
        </div>

        <div class="onboarding-footer">
            <button class="btn-continue" id="btn-continue" onclick="nextStep()">CONTINUAR (0/6)</button>
        </div>
    </div>

    <script>
        const API_URL = "https://pkfilmes.pages.dev/movies_data.json";
        let allData = [];
        let selectedMovies = [];
        let selectedCategories = [];
        let selectedSagas = [];
        let currentStep = 1;
        let searchTimeout;

        const sagasList = [
            { name: 'Harry Potter', img: 'https://images.tcdn.com.br/img/img_prod/697730/poster_p_filme_harry_potter_e_a_pedra_filosofal_c_1147_1_20201013150811.jpg' },
            { name: 'Game of Thrones', img: 'https://m.media-amazon.com/images/I/918S-uX9p8L._AC_SL1500_.jpg' },
            { name: 'Piratas do Caribe', img: 'https://m.media-amazon.com/images/I/71y7X6xY0TL._AC_SL1000_.jpg' },
            { name: 'Maze Runner', img: 'https://m.media-amazon.com/images/I/91G9uY8vR0L._AC_SL1500_.jpg' },
            { name: 'Vingadores', img: 'https://m.media-amazon.com/images/I/719f649H1hL._AC_SL1000_.jpg' },
            { name: 'Star Wars', img: 'https://m.media-amazon.com/images/I/812W97VV6pL._AC_SL1500_.jpg' },
            { name: 'Senhor dos Anéis', img: 'https://m.media-amazon.com/images/I/71lKVr5YqrL._AC_SL1000_.jpg' },
            { name: 'Matrix', img: 'https://m.media-amazon.com/images/I/71Yg9qXHe-L._AC_SL1000_.jpg' }
        ];

        async function init() {
            try {
                document.getElementById('loading-indicator').style.display = 'block';
                const res = await fetch(API_URL);
                allData = await res.json();
                document.getElementById('loading-indicator').style.display = 'none';
                
                renderOnboardingMovies();
                renderOnboardingCategories();
                renderOnboardingSagas();
                
                document.getElementById('onboarding-search').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        renderOnboardingMovies(e.target.value);
                    }, 300);
                });
            } catch (e) { 
                console.error("Erro ao carregar dados:", e);
                document.getElementById('loading-indicator').innerHTML = 'Erro ao carregar. Tente recarregar a página.';
            }
        }

        function renderOnboardingMovies(query = '') {
            const grid = document.getElementById('onboarding-movies-grid');
            let filtered = allData;
            
            if (query.trim()) {
                filtered = allData.filter(m => 
                    m.nome.toLowerCase().includes(query.toLowerCase()) ||
                    (m.titulo && m.titulo.toLowerCase().includes(query.toLowerCase()))
                );
            }

            const displayList = filtered.slice(0, 60);

            grid.innerHTML = displayList.map(movie => `
                <div class="selectable-card ${selectedMovies.includes(movie.id) ? 'selected' : ''}" 
                     onclick="toggleMovieSelection('${movie.id}')" 
                     title="${movie.nome}">
                    <img src="${movie.capa}" alt="${movie.nome}" loading="lazy">
                </div>
            `).join('');
            
            updateContinueButton();
        }

        window.toggleMovieSelection = (id) => {
            if (selectedMovies.includes(id)) {
                selectedMovies = selectedMovies.filter(mid => mid !== id);
            } else {
                selectedMovies.push(id);
            }
            renderOnboardingMovies(document.getElementById('onboarding-search').value);
        };

        function renderOnboardingCategories() {
            const genres = new Set();
            allData.forEach(item => { 
                if (item.generos) {
                    item.generos.split(',').forEach(g => {
                        const genre = g.trim();
                        if (genre && genre !== 'Talk' && genre !== 'Kids') {
                            genres.add(genre);
                        }
                    });
                }
            });
            
            const grid = document.getElementById('onboarding-categories-grid');
            grid.innerHTML = Array.from(genres).sort().map(genre => `
                <div class="selectable-tag ${selectedCategories.includes(genre) ? 'selected' : ''}" 
                     onclick="toggleCategorySelection('${genre}')">${genre}</div>
            `).join('');
        }

        window.toggleCategorySelection = (genre) => {
            if (selectedCategories.includes(genre)) {
                selectedCategories = selectedCategories.filter(g => g !== genre);
            } else {
                selectedCategories.push(genre);
            }
            renderOnboardingCategories();
            updateContinueButton();
        };

        function renderOnboardingSagas() {
            const grid = document.getElementById('onboarding-sagas-grid');
            grid.innerHTML = sagasList.map(saga => `
                <div class="saga-card ${selectedSagas.includes(saga.name) ? 'selected' : ''}" 
                     style="background-image: url('${saga.img}')"
                     onclick="toggleSagaSelection('${saga.name}', this)">
                    <span>${saga.name}</span>
                </div>
            `).join('');
        }
	        window.toggleSagaSelection = (saga, el) => {
            if (selectedSagas.includes(saga)) {
                selectedSagas = selectedSagas.filter(s => s !== saga);
                el.classList.remove('selected');
            } else {
                selectedSagas.push(saga);
                el.classList.add('selected');
            }
            updateContinueButton();
        };

        function updateContinueButton() {
            const btn = document.getElementById('btn-continue');
            if (currentStep === 1) {
                btn.innerText = `CONTINUAR (${selectedMovies.length}/6)`;
                btn.classList.toggle('active', selectedMovies.length >= 6);
            } else if (currentStep === 2) {
                btn.innerText = `CONTINUAR (${selectedCategories.length}/3)`;
                btn.classList.toggle('active', selectedCategories.length >= 3);
            } else {
                btn.innerText = `FINALIZAR (${selectedSagas.length}/1)`;
                btn.classList.toggle('active', selectedSagas.length >= 1);
            }
        }

        window.nextStep = () => {
            if (currentStep === 1 && selectedMovies.length >= 6) {
                document.getElementById('step-movies').classList.remove('active');
                document.getElementById('step-categories').classList.add('active');
                currentStep = 2;
            } else if (currentStep === 2 && selectedCategories.length >= 3) {
                document.getElementById('step-categories').classList.remove('active');
                document.getElementById('step-sagas').classList.add('active');
                currentStep = 3;
            } else if (currentStep === 3 && selectedSagas.length >= 1) {
                finishOnboarding();
            }
            updateContinueButton();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function finishOnboarding() {
            localStorage.setItem('pk_onboarding_finished', 'true');
            localStorage.setItem('pk_fav_movies', JSON.stringify(selectedMovies));
            localStorage.setItem('pk_fav_categories', JSON.stringify(selectedCategories));
            localStorage.setItem('pk_fav_sagas', JSON.stringify(selectedSagas));
            window.location.href = 'inicio.html';
        }

        init();
    </script>
</body>
</html>
